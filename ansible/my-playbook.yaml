- name: Install Docker
  hosts: aws_ec2
  become: yes
  tasks:
    - name: Ensure Docker is installed
      yum:
        name: docker
        update_cache: yes
        state: present

- name: Install Docker Compose
  hosts: aws_ec2
  become: yes
  tasks:
    - name: Get architecture of remote machine
      shell: echo `uname -s`-`uname -m`
      register: remote_arch
    - name: Download and install Docker Compose
      get_url:
        url: https://github.com/docker/compose/releases/latest/download/docker-compose-{{ remote_arch.stdout }}
        dest: /usr/local/bin/docker-compose
        mode: +x

- name: Start Docker
  hosts: aws_ec2
  become: yes
  tasks:
    - name: Ensure Docker daemon is started
      systemd:
        name: docker
        state: started

- name: Add ec2-user to docker group
  hosts: aws_ec2
  become: yes
  tasks:
    - name: Add ec2-user to docker group
      user:
        name: ec2-user
        groups: docker
        append: yes
    - name: Reset ssh connection to allow user changes to affect 'current login user'
      meta: reset_connection

- name: Install pip3
  hosts: aws_ec2
  become: yes
  tasks:
    - name: Ensure pip3 is installed
      yum:
        name: python3-pip
        update_cache: yes
        state: present

- name: Install required Python modules
  hosts: aws_ec2
  tasks:
    - name: Install Python modules 'docker' and 'docker-compose'
      pip:
        name:
          - docker
          - docker-compose
